<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Cart - Chicken Store</title>
    <style>
        body { margin:0; font-family:Arial, sans-serif; background:#f8f9fa; }
        header { background:#dc3545; color:#fff; padding:15px; text-align:center; font-size:24px; }
        nav { display:flex; justify-content:space-between; align-items:center; background:#fff; padding:10px 20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .cart-container { width:90%; max-width:800px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
        .cart-item { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; }
        .cart-item img { width:80px; height:60px; object-fit:cover; border-radius:5px; }
        .item-info { flex:1; margin-left:15px; }
        .quantity { display:flex; align-items:center; gap:10px; }
        .quantity button { width:30px; height:30px; border:none; border-radius:50%; background:#dc3545; color:white; font-size:18px; cursor:pointer; }
        .total { text-align:right; font-size:20px; margin-top:20px; font-weight:bold; }
        .checkout button { padding:10px 20px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; font-size:16px; }
    </style>
</head>
<body>
<header>Chicken E-Commerce</header>
<nav>
    <div class="brand">üêî Chicken Store</div>
    <button onclick="location.href='/index.html'">‚¨Ö Continue Shopping</button>
</nav>

<div class="cart-container">
    <h2>Your Cart</h2>
    <div id="cartItems">Loading...</div>
    <div class="total" id="totalPrice">Total: ‚Çπ0</div>
    <div class="checkout">
        <button onclick="checkout()">Proceed to Checkout</button>
    </div>
</div>

<script>
    const API_BASE = "https://chicken-commerce.onrender.com";
    let cart = [];

    async function loadCart() {
      try {
        const res = await fetch(${API_BASE}/api/cart);
        if (!res.ok) throw new Error('Cart fetch failed');
        cart = await res.json();
        renderCart();
      } catch (err) {
        console.error(err);
        document.getElementById('cartItems').innerHTML = '<p>‚ö† Unable to load cart.</p>';
        document.getElementById('totalPrice').innerText = 'Total: ‚Çπ0';
      }
    }

    function renderCart() {
      const container = document.getElementById('cartItems');
      container.innerHTML = '';
      if (!cart || cart.length === 0) {
        container.innerHTML = '<p>Your cart is empty üõí</p>';
        document.getElementById('totalPrice').innerText = 'Total: ‚Çπ0';
        return;
      }
      let total = 0;
      cart.forEach(item => {
        const qty = item.quantity || 1;
        const price = item.product?.price || 0;
        total += price * qty;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <img src="${item.product?.imgUrl || '/images/tshirt.jpg'}" alt="${item.product?.name}">
          <div class="item-info">
            <h3>${item.product?.name || 'Unknown'}</h3>
            <p>‚Çπ${price}</p>
          </div>
          <div class="quantity">
            <button onclick="updateQty(${item.id}, ${qty - 1})">-</button>
            <span id="qty-${item.id}">${qty}</span>
            <button onclick="updateQty(${item.id}, ${qty + 1})">+</button>
            <button style="margin-left:10px;background:#dc3545;color:#fff;padding:6px;border-radius:4px;border:none;" onclick="removeItem(${item.id})">Remove</button>
          </div>
        `;
        container.appendChild(div);
      });
      document.getElementById('totalPrice').innerText = 'Total: ‚Çπ' + total;
      localStorage.setItem('cartTotal', total);
    }

    async function updateQty(itemId, newQty) {
      try {
        if (newQty <= 0) {
          await fetch(${API_BASE}/api/cart/${itemId}, { method: 'DELETE' });
        } else {
          await fetch(${API_BASE}/api/cart/${itemId}, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ qty: newQty })
          });
        }
        await loadCart();
      } catch (err) {
        console.error(err);
        alert('Failed to update cart');
      }
    }

    async function removeItem(id) {
      try {
        await fetch(${API_BASE}/api/cart/${id}, { method: 'DELETE' });
        await loadCart();
      } catch (err) {
        console.error(err);
      }
    }

    function checkout() {
      if (!cart || cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      window.location.href = '/address.html';
    }

    loadCart();
</script>
</body>
</html>